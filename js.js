// === Ï†ÑÏ≤¥ JavaScript ÏΩîÎìú (API ÌÇ§ ÏßÅÏ†ë Ìè¨Ìï® + Î™®Îì† Í∏∞Îä•) ===

// --- Îç∞Ïù¥ÌÑ∞ ---
let hotelData = [];
const currencies = ["VND", "USD", "TWD", "THB", "SGD", "NZD", "MYR", "JPY", "HKD", "GBP", "EUR", "CZK", "CNY", "CHF", "CAD", "AUD", "PHP", "MOP", "HUF", "IDR", "HRK"];

// --- Ìï®Ïàò Ï†ïÏùò ---

async function loadHotelsFromCMS() {
    const CMS_SPACE_ID = 'imbg4efg59wo';
    // üö® Î≥¥Ïïà Ï£ºÏùò: Ïã§Ï†ú Access TokenÏù¥ ÏΩîÎìúÏóê Ìè¨Ìï®ÎêòÏñ¥ ÏûàÏäµÎãàÎã§!
    const CMS_ACCESS_TOKEN = 'iNAsd2_-D9rc7oGpsD-NiviCaNr15S8lhbgPXmwnT_A';
    const CMS_API_ENDPOINT = `https://cdn.contentful.com/spaces/${CMS_SPACE_ID}/environments/master/entries?content_type=hotel`;
    console.log("Attempting to load data from Contentful:", CMS_API_ENDPOINT);
    try {
        const response = await fetch(CMS_API_ENDPOINT, { method: 'GET', headers: { 'Authorization': `Bearer ${CMS_ACCESS_TOKEN}`, 'Content-Type': 'application/json' } });
        if (!response.ok) { throw new Error(`Contentful API error! status: ${response.status}, ${response.statusText}`); }
        const rawData = await response.json();
        console.log("Raw data from Contentful:", rawData);
        if (rawData.items && Array.isArray(rawData.items)) {
             hotelData = rawData.items.map(item => ({ id: item.fields.hotelId || item.sys.id, name: item.fields.hotelName || 'Untitled Hotel', categories: item.fields.roomCategories || [] }));
        } else { console.error("Unexpected data structure from Contentful:", rawData); throw new Error("Could not parse hotel data from Contentful response."); }
        console.log('Hotel data processed:', hotelData);
    } catch (error) { console.error('Failed to load hotel data from Contentful:', error); alert('Ìò∏ÌÖî Îç∞Ïù¥ÌÑ∞Î•º ContentfulÏóêÏÑú Î∂àÎü¨Ïò§Îäî Îç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§. Space ID, Access Token, ÏΩòÌÖêÏ∏† ÌÉÄÏûÖ ID Î∞è ÎÑ§Ìä∏ÏõåÌÅ¨Î•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.'); hotelData = []; }
}

function populateHotelSelectAndCategories(hotelSelect, categorySelect) {
    console.log("--- Inside populateHotelSelectAndCategories ---"); console.log("Populating with hotelData:", JSON.stringify(hotelData, null, 2));
    while (hotelSelect.options.length > 1) { hotelSelect.remove(1); }
    if (!hotelData || hotelData.length === 0) { hotelSelect.options[0].textContent = "-- Ìò∏ÌÖî Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå --"; if (categorySelect) categorySelect.options[0].textContent = "-- Ìò∏ÌÖî Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå --"; console.warn("Hotel data is empty. Skipping population."); return; }
    console.log(`Found ${hotelData.length} hotels. Starting loop...`);
    hotelData.forEach((hotel, index) => {
         console.log(`Processing hotel ${index + 1}:`, JSON.stringify(hotel)); if (!hotel || typeof hotel.id === 'undefined' || typeof hotel.name === 'undefined') { console.error(`Hotel object at index ${index} seems invalid. Skipping.`, hotel); return; }
         try { const option = document.createElement('option'); option.value = hotel.id; option.textContent = hotel.name; console.log("Appending option:", option.value, option.textContent); hotelSelect.appendChild(option); } catch(e) { console.error(`Error appending option for hotel ${index+1}:`, e, hotel); }
    });
    console.log("Finished appending options to hotel select."); hotelSelect.value = ""; if (categorySelect) populateCategorySelect(null, categorySelect); console.log("--- Exiting populateHotelSelectAndCategories ---");
}
function populateCategorySelect(hotelId, categorySelect) {
    console.log(">>> [7] Populating category select for hotelId:", hotelId); while (categorySelect.options.length > 1) { categorySelect.remove(1); } categorySelect.value = ""; if (!hotelId) { categorySelect.options[0].textContent = "-- Ìò∏ÌÖî Î®ºÏ†Ä ÏÑ†ÌÉù --"; return; } const selectedHotel = hotelData.find(hotel => hotel.id === hotelId); console.log("    Found selected hotel data:", selectedHotel); if (selectedHotel && selectedHotel.categories && Array.isArray(selectedHotel.categories)) { categorySelect.options[0].textContent = "-- Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ†ÌÉù --"; console.log(`    Found ${selectedHotel.categories.length} categories. Looping...`); selectedHotel.categories.forEach(category => { const option = document.createElement('option'); option.value = category; option.textContent = category; categorySelect.appendChild(option); }); console.log("    Finished populating categories."); } else { categorySelect.options[0].textContent = "-- Ïπ¥ÌÖåÍ≥†Î¶¨ ÏóÜÏùå --"; console.warn("    No categories found for this hotel or data format error."); } console.log(">>> [8] Exiting populateCategorySelect");
}
function calculateCheckoutDate(checkinInput, nightsInput, checkoutDisplay) { const checkinValue = checkinInput.value; const nightsValue = parseInt(nightsInput.value, 10); if (!checkinValue || isNaN(nightsValue) || nightsValue <= 0) { checkoutDisplay.value = ''; return; } try { const checkinDate = new Date(checkinValue); const checkoutDate = new Date(checkinDate.getTime()); checkoutDate.setDate(checkoutDate.getDate() + nightsValue); const year = checkoutDate.getFullYear(); const month = String(checkoutDate.getMonth() + 1).padStart(2, '0'); const day = String(checkoutDate.getDate()).padStart(2, '0'); checkoutDisplay.value = `${year}-${month}-${day}`; } catch (error) { console.error("Ï≤¥ÌÅ¨ÏïÑÏõÉ ÎÇ†Ïßú Í≥ÑÏÇ∞ Ïò§Î•ò:", error); checkoutDisplay.value = 'ÎÇ†Ïßú Í≥ÑÏÇ∞ Ïò§Î•ò'; } }
function formatDateForOutput(dateString) { if (!dateString || dateString === 'ÎÇ†Ïßú Í≥ÑÏÇ∞ Ïò§Î•ò') return ''; try { const parts = dateString.split('-'); if (parts.length !== 3) throw new Error('Invalid date format'); const year = parseInt(parts[0], 10); const monthIndex = parseInt(parts[1], 10) - 1; const day = parseInt(parts[2], 10); const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"]; const dateObj = new Date(Date.UTC(year, monthIndex, day)); if (isNaN(dateObj.getTime()) || dateObj.getUTCFullYear() !== year || dateObj.getUTCMonth() !== monthIndex || dateObj.getUTCDate() !== day) { throw new Error('Invalid date components'); } return `${day}-${monthNames[monthIndex]}-${year}`; } catch (e) { console.error("ÎÇ†Ïßú ÌòïÏãù Î≥ÄÌôò Ïò§Î•ò:", e, "ÏûÖÎ†•Í∞í:", dateString); return dateString; } }
function updateGuestNameInputs(numberOfRooms, container) { container.innerHTML = ''; const num = parseInt(numberOfRooms, 10); if (isNaN(num) || num < 1) return; for (let i = 1; i <= num; i++) { const roomDiv = document.createElement('div'); roomDiv.classList.add('guest-input-group'); const label = document.createElement('label'); label.textContent = `ROOM ${i}:`; label.htmlFor = `guestNameRoom${i}`; const input = document.createElement('input'); input.type = 'text'; input.id = `guestNameRoom${i}`; input.classList.add('guest-name-input'); input.placeholder = 'Last/First Title (Ïòà: JUNG/KEUNCHAE MR)'; input.required = true; roomDiv.appendChild(label); roomDiv.appendChild(input); container.appendChild(roomDiv); } }
function createCurrencyCheckboxes(containerId, currencyList) { const container = document.getElementById(containerId); if (!container) { console.error(`Element with ID '${containerId}' not found.`); return; } container.innerHTML = ''; const labelSpan = document.createElement('span'); labelSpan.classList.add('currency-label'); labelSpan.textContent = 'ÌÜµÌôî:'; container.appendChild(labelSpan); currencyList.forEach((currencyCode, index) => { const itemDiv = document.createElement('div'); itemDiv.classList.add('currency-item'); const checkbox = document.createElement('input'); checkbox.type = 'checkbox'; checkbox.id = `curr_${currencyCode.toLowerCase()}`; checkbox.name = 'currency'; checkbox.value = currencyCode; if (index === 0) { checkbox.checked = true; } checkbox.addEventListener('change', (event) => { const currentCheckbox = event.target; if (currentCheckbox.checked) { const allCheckboxes = container.querySelectorAll('input[name="currency"]'); allCheckboxes.forEach(cb => { if (cb !== currentCheckbox) { cb.checked = false; } }); } else { const checkedCount = container.querySelectorAll('input[name="currency"]:checked').length; if (checkedCount === 0) { currentCheckbox.checked = true; } } }); const label = document.createElement('label'); label.htmlFor = checkbox.id; label.textContent = currencyCode; itemDiv.appendChild(checkbox); itemDiv.appendChild(label); container.appendChild(itemDiv); }); }
function generateOutput(elements) { const hotelNameValue = elements.hotelSelect.options[elements.hotelSelect.selectedIndex].text; const checkinValue = elements.checkinDateInput.value; const nightsValue = elements.nightsInput.value; const checkoutValue = elements.checkoutDateDisplay.value; const numRoomsValue = elements.numRoomsInput.value; const roomCategoryValue = elements.categorySelect.value; const roomRateValue = elements.roomRateInput.value; const specialRequestsValue = elements.specialRequestsTextarea.value; const guestInputs = elements.guestNameInputsContainer.querySelectorAll('.guest-name-input'); let guestListString = ''; let allGuestsEntered = true; guestInputs.forEach((input, index) => { const guestName = input.value.trim(); if (guestName) { guestListString += `Room ${index + 1}. ${guestName}\n`; } else { allGuestsEntered = false; } }); guestListString = guestListString.trim(); const checkedBoxes = elements.requestCheckboxesContainer.querySelectorAll('input[name="common_request"]:checked'); const selectedRequests = []; checkedBoxes.forEach(checkbox => { selectedRequests.push(checkbox.value); }); const checkboxRequestString = selectedRequests.join(', '); const freeTextRequest = specialRequestsValue.trim(); let finalRequestString = ''; if (checkboxRequestString) { finalRequestString += checkboxRequestString; } if (freeTextRequest) { if (finalRequestString) { finalRequestString += `\n${freeTextRequest}`; } else { finalRequestString += freeTextRequest; } } if (!finalRequestString) { finalRequestString = 'None'; } const selectedCurrencyElement = document.querySelector('#currencySelection input[name="currency"]:checked'); const selectedCurrencyValue = selectedCurrencyElement ? selectedCurrencyElement.value : ''; if (!hotelNameValue || elements.hotelSelect.selectedIndex === 0 || !checkinValue || !nightsValue || nightsValue <= 0 || !checkoutValue || !numRoomsValue || numRoomsValue <= 0 || !roomCategoryValue || elements.categorySelect.selectedIndex === 0 || !allGuestsEntered || !roomRateValue || roomRateValue < 0 || checkoutValue === 'ÎÇ†Ïßú Í≥ÑÏÇ∞ Ïò§Î•ò' || !selectedCurrencyValue) { alert('Î™®Îì† ÌïÑÏàò Ìï≠Î™©ÏùÑ Ïò¨Î∞îÎ•¥Í≤å ÏûÖÎ†•/ÏÑ†ÌÉùÌïòÍ≥† ÎÇ†ÏßúÏôÄ Î∞ïÏàò, Ìà¨ÏàôÍ∞ù Ïù¥Î¶Ñ, ÌÜµÌôî Îã®ÏúÑÎ•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.\n(Î∞ïÏàò, Í∞ùÏã§ ÏàòÎäî 1 Ïù¥ÏÉÅ, ÏöîÍ∏àÏùÄ 0 Ïù¥ÏÉÅÏù¥Ïñ¥Ïïº Ìï©ÎãàÎã§)'); elements.outputArea.value = ''; elements.copyButton.style.display = 'none'; return; } if (!checkoutValue || checkoutValue === 'ÎÇ†Ïßú Í≥ÑÏÇ∞ Ïò§Î•ò'){ alert('Ï≤¥ÌÅ¨ÏïÑÏõÉ ÎÇ†Ïßú Í≥ÑÏÇ∞Ïóê Î¨∏Ï†úÍ∞Ä ÏûàÏäµÎãàÎã§. Ï≤¥ÌÅ¨Ïù∏ ÎÇ†ÏßúÏôÄ Î∞ïÏàòÎ•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.'); return; } const checkinFormatted = formatDateForOutput(checkinValue); const checkoutFormatted = formatDateForOutput(checkoutValue); if (checkinFormatted === checkinValue || checkoutFormatted === checkoutValue) { console.warn("ÎÇ†Ïßú ÌòïÏãùÏù¥<y_bin_46>-MM-DDÎ°ú ÌëúÏãúÎê† Ïàò ÏûàÏäµÎãàÎã§. formatDateForOutput Ìï®Ïàò ÌôïÏù∏ ÌïÑÏöî."); } const outputText = `Greetings from Naeil Tour, Korea!\nPlease find the new booking request as below and confirm the booking.\n\n[Booking Details]\nHotel: ${hotelNameValue}\nCheck in: ${checkinFormatted}\nCheck out: ${checkoutFormatted}\nRoom Type: ${roomCategoryValue}\nNights: ${nightsValue} Nights\nRooms: ${numRoomsValue} Rooms\n\nGuest Name(Last/First):\n${guestListString}\n\nRoom Rate: ${Number(roomRateValue).toLocaleString()} ${selectedCurrencyValue}\nRequest: ${finalRequestString}\n\nLooking forward to hearing from you soon.\n\nBest regards,\nNaeil Tour\n`; elements.outputArea.value = outputText.trim(); elements.copyButton.style.display = 'inline-block'; }
function copyOutput(outputArea, copyButton) { if (!outputArea.value) return; navigator.clipboard.writeText(outputArea.value) .then(() => { const originalText = copyButton.textContent; copyButton.textContent = 'Î≥µÏÇ¨ ÏôÑÎ£å!'; setTimeout(() => { copyButton.textContent = originalText; }, 1500); }) .catch(err => { console.error('Î≥µÏÇ¨ Ïã§Ìå®: ', err); alert('ÎÇ¥Ïö© Î≥µÏÇ¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.'); }); }
function isValidDateYYYYMMDD(dateString) { if (!/^\d{4}-\d{2}-\d{2}$/.test(dateString)) { return false; } const parts = dateString.split("-"); const year = parseInt(parts[0], 10); const month = parseInt(parts[1], 10); const day = parseInt(parts[2], 10); if (month < 1 || month > 12 || day < 1 || day > 31) { return false; } const testDate = new Date(year, month - 1, day); if (isNaN(testDate.getTime()) || testDate.getFullYear() !== year || testDate.getMonth() !== month - 1 || testDate.getDate() !== day) { return false; } return true; }

// --- === ÏΩîÎìú Ïã§Ìñâ ÏãúÏûë (DOM Î°úÎìú ÌõÑ) === ---
document.addEventListener('DOMContentLoaded', async () => {
    console.log(">>> DOM Content Loaded. Starting initialization...");
    await loadHotelsFromCMS();
    console.log(">>> Data loading finished. Proceeding with UI setup...");
    const hotelSelect = document.getElementById('hotelName'); const categorySelect = document.getElementById('roomCategory'); const checkinDateInput = document.getElementById('checkinDate'); const nightsInput = document.getElementById('nightsInput'); const checkoutDateDisplay = document.getElementById('checkoutDateDisplay'); const numRoomsInput = document.getElementById('numRooms'); const guestNameInputsContainer = document.getElementById('guestNameInputsContainer'); const roomRateInput = document.getElementById('roomRate'); const currencyContainerId = 'currencySelection'; const requestCheckboxesContainer = document.getElementById('requestCheckboxes'); const specialRequestsTextarea = document.getElementById('specialRequests'); const generateButton = document.getElementById('generateButton'); const outputArea = document.getElementById('outputArea'); const copyButton = document.getElementById('copyButton');
    console.log(">>> Getting DOM elements...");
    console.log(">>> Initializing UI components...");
    populateHotelSelectAndCategories(hotelSelect, categorySelect); updateGuestNameInputs(numRoomsInput.value, guestNameInputsContainer); calculateCheckoutDate(checkinDateInput, nightsInput, checkoutDateDisplay); createCurrencyCheckboxes(currencyContainerId, currencies);
    console.log(">>> UI components initialized.");
    console.log(">>> Registering event listeners...");
    hotelSelect.addEventListener('change', () => { populateCategorySelect(hotelSelect.value, categorySelect); });
    checkinDateInput.addEventListener('change', () => { calculateCheckoutDate(checkinDateInput, nightsInput, checkoutDateDisplay); });
    nightsInput.addEventListener('input', () => { calculateCheckoutDate(checkinDateInput, nightsInput, checkoutDateDisplay); });
    checkinDateInput.addEventListener('paste', (event) => { event.preventDefault(); const pastedText = event.clipboardData.getData('text/plain').trim(); if (isValidDateYYYYMMDD(pastedText)) { checkinDateInput.value = pastedText; checkinDateInput.dispatchEvent(new Event('change')); } else { alert('Î∂ôÏó¨ÎÑ£Í∏∞ Ïã§Ìå®: ÎÇ†Ïßú ÌòïÏãùÏù¥ Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.\nYYYY-MM-DD ÌòïÏãùÏúºÎ°ú ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî. (Ïòà: 2025-08-10)'); } });
    numRoomsInput.addEventListener('input', () => { updateGuestNameInputs(numRoomsInput.value, guestNameInputsContainer); });
    generateButton.addEventListener('click', () => { generateOutput({ hotelSelect, categorySelect, checkinDateInput, nightsInput, checkoutDateDisplay, numRoomsInput, guestNameInputsContainer, roomRateInput, requestCheckboxesContainer, specialRequestsTextarea, outputArea, copyButton }); });
    copyButton.addEventListener('click', () => { copyOutput(outputArea, copyButton); });
    console.log(">>> Event listeners registered.");
    console.log(">>> Initialization complete.");
}); // End of DOMContentLoaded
